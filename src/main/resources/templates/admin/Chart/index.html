<!DOCTYPE html>
<html layout:decorate="~{admin/fragments/_layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Dashboard – SGU Heart Admin</title>
</head>

<body>
    <div layout:fragment="content">

        <!-- ── Page Header ── -->
        <div class="page-header">
            <div>
                <h1>Dashboard</h1>
                <div class="breadcrumb">
                    <span>Admin</span> / <span style="color:#6366f1;">Dashboard</span>
                </div>
            </div>
            <a th:href="@{/}" target="_blank" class="btn btn-light" style="gap:8px;">
                <i class="bi bi-eye me-1"></i>View Site
            </a>
        </div>

        <!-- ── Stat Cards ── -->
        <div class="row g-4 mb-4">

            <!-- Total Donations Amount -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-1">
                    <div class="stat-icon">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="stat-label">Total Raised</div>
                    <div class="stat-value"
                        th:text="${totalDonationsAmount != null ? #numbers.formatDecimal(totalDonationsAmount, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">
                        0 ₫
                    </div>
                    <div class="stat-sub">All-time donation amount</div>
                </div>
            </div>

            <!-- Total Donations Count -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-2">
                    <div class="stat-icon">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    <div class="stat-label">Total Donations</div>
                    <div class="stat-value" th:text="${totalDonationsCount}">0</div>
                    <div class="stat-sub">Successful transactions</div>
                </div>
            </div>

            <!-- Total Programs -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-3">
                    <div class="stat-icon">
                        <i class="bi bi-journal-richtext"></i>
                    </div>
                    <div class="stat-label">Active Programs</div>
                    <div class="stat-value" th:text="${totalPrograms}">0</div>
                    <div class="stat-sub">Fundraising campaigns</div>
                </div>
            </div>

            <!-- Registered Users -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-4">
                    <div class="stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-label">Registered Users</div>
                    <div class="stat-value" th:text="${totalUsers}">0</div>
                    <div class="stat-sub">Community members</div>
                </div>
            </div>
        </div>

        <!-- ── Doughnut Charts ── -->
        <div class="row g-4 mb-4">
            <!-- Doughnut – by program -->
            <div class="col-xl-4 col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-pie-chart-fill me-2 text-info"></i>By Program</h6>
                    </div>
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <div class="chart-pie">
                            <canvas id="programPieChart"></canvas>
                        </div>
                        <div id="pieLegend" class="mt-3 w-100" style="font-size:12px;"></div>
                    </div>
                </div>
            </div>

            <!-- Doughnut Chart – Payment Methods -->
            <div class="col-xl-4 col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-wallet2 me-2 text-warning"></i>By Payment Method</h6>
                    </div>
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <div class="chart-pie">
                            <canvas id="paymentMethodsChart"></canvas>
                        </div>
                        <div id="paymentMethodsLegend" class="mt-3 w-100" style="font-size:12px;"></div>
                    </div>
                </div>
            </div>

            <!-- Doughnut Chart – By Category -->
            <div class="col-xl-4 col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-bookmarks-fill me-2 text-secondary"></i>By Category</h6>
                    </div>
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <div class="chart-pie">
                            <canvas id="categoryPieChart"></canvas>
                        </div>
                        <div id="categoryPieLegend" class="mt-3 w-100" style="font-size:12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── Bar Charts ── -->
        <div class="row g-4 mb-4">
            <!-- Bar Chart – Top Donors -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-bar-chart-fill me-2" style="color:#10b981;"></i>Top 5 Donors</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-area flex-grow-1">
                            <canvas id="topDonorsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Program Fundraising Progress -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-bar-chart-steps me-2 text-primary"></i>Program Fundraising Progress</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-area flex-grow-1">
                            <canvas id="programProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── User Growth Chart ── -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-graph-up-arrow me-2 text-success"></i>New Users Over Time</h6>
                        <span class="badge" style="background:#dcfce7; color:#16a34a; font-size:11px;">Last 30
                            days</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="height: 350px;">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── Quick Links ── -->
        <div class="row g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="bi bi-lightning-charge me-2 text-warning"></i>Quick Access</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/user}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#e0e7ff'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-people-fill fs-3 mb-2" style="color:#6366f1;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Users</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/programs}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#d1fae5'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-journal-richtext fs-3 mb-2" style="color:#10b981;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Programs</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/donations}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#cffafe'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-cash-coin fs-3 mb-2" style="color:#06b6d4;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Donations</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/blogs}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#fef3c7'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-file-text-fill fs-3 mb-2" style="color:#f59e0b;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Blogs</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ── Chart Scripts ── -->
    <th:block layout:fragment="scripts">
        <script>
            // ── Palette ──────────────────────────────────────────────────────
            const PALETTE = ['#6366f1', '#10b981', '#06b6d4', '#f59e0b', '#ef4444',
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16'];


            // ── Doughnut Chart : By Program ───────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/donations/total-donations-by-program');
                    const data = await resp.json();
                    const labels = data.map(d => d.programName || d[0] || 'Unknown');
                    const amounts = data.map(d => d.totalAmount || d[1] || 0);
                    const colors = PALETTE.slice(0, labels.length);

                    const ctx = document.getElementById('programPieChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data: amounts,
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#fff',
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '68%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.label + ': ' + ctx.parsed.toLocaleString('vi-VN') + ' ₫'
                                    }
                                }
                            }
                        }
                    });

                    // Custom legend
                    const legend = document.getElementById('pieLegend');
                    labels.forEach((label, i) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px;';
                        item.innerHTML = `
                <div style="width:10px;height:10px;border-radius:3px;background:${colors[i]};flex-shrink:0;"></div>
                <span style="flex:1;color:#475569;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
                <span style="font-weight:600;color:#1e293b;">${amounts[i].toLocaleString('vi-VN')} ₫</span>
            `;
                        legend.appendChild(item);
                    });
                } catch (e) {
                    console.error('Pie chart error:', e);
                }
            })();

            // ── Bar Chart : Top Donors ───────────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/donations/top-donors?limit=5');
                    const data = await resp.json();

                    const labels = data.map(d => d.donorName || d[0] || 'Unknown');
                    const amounts = data.map(d => d.totalAmount || d[1] || 0);

                    const ctx = document.getElementById('topDonorsChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Donations (₫)',
                                data: amounts,
                                backgroundColor: '#10b981',
                                hoverBackgroundColor: '#059669',
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.parsed.y.toLocaleString('vi-VN') + ' ₫'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 11 }, color: '#64748b' }
                                },
                                y: {
                                    grid: { color: '#f1f5f9' },
                                    beginAtZero: true,
                                    ticks: {
                                        font: { size: 11 }, color: '#64748b',
                                        callback: v => (v >= 1000000 ? (v / 1000000).toFixed(1) + 'M' : v.toLocaleString()) + ' ₫'
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error('Top Donors chart error:', e);
                }
            })();

            // ── Doughnut Chart : By Category ───────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/donations/total-donations-by-category');
                    const data = await resp.json();

                    const labels = data.map(d => d.categoryName || d[0] || 'Unknown');
                    const amounts = data.map(d => d.totalAmount || d[1] || 0);
                    // Distinct colors for categories
                    const colors = ['#8b5cf6', '#ec4899', '#14b8a6', '#f59e0b', '#6366f1'].slice(0, labels.length);

                    const ctx = document.getElementById('categoryPieChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data: amounts,
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#fff',
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '68%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.label + ': ' + ctx.parsed.toLocaleString('vi-VN') + ' ₫'
                                    }
                                }
                            }
                        }
                    });

                    // Custom legend
                    const legend = document.getElementById('categoryPieLegend');
                    labels.forEach((label, i) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px;';
                        item.innerHTML = `
                <div style="width:10px;height:10px;border-radius:3px;background:${colors[i]};flex-shrink:0;"></div>
                <span style="flex:1;color:#475569;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
                <span style="font-weight:600;color:#1e293b;">${amounts[i].toLocaleString('vi-VN')} ₫</span>
            `;
                        legend.appendChild(item);
                    });
                } catch (e) {
                    console.error('Category chart error:', e);
                }
            })();

            // ── Doughnut Chart : Payment Methods ─────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/donations/payment-methods');
                    const data = await resp.json();

                    const labels = data.map(d => d.paymentMethod || d[0] || 'Unknown');
                    const amounts = data.map(d => d.totalAmount || d[1] || 0);
                    // Use different colors for variety
                    const colors = ['#f59e0b', '#06b6d4', '#6366f1', '#ec4899', '#84cc16'].slice(0, labels.length);

                    const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data: amounts,
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#fff',
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '68%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.label + ': ' + ctx.parsed.toLocaleString('vi-VN') + ' ₫'
                                    }
                                }
                            }
                        }
                    });

                    // Custom legend
                    const legend = document.getElementById('paymentMethodsLegend');
                    labels.forEach((label, i) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px;';
                        item.innerHTML = `
                <div style="width:10px;height:10px;border-radius:3px;background:${colors[i]};flex-shrink:0;"></div>
                <span style="flex:1;color:#475569;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
                <span style="font-weight:600;color:#1e293b;">${amounts[i].toLocaleString('vi-VN')} ₫</span>
            `;
                        legend.appendChild(item);
                    });
                } catch (e) {
                    console.error('Payment Methods chart error:', e);
                }
            })();

            // ── Horizontal Bar Chart : Program Progress ───────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/chart/program-progress');
                    const data = await resp.json();

                    const labels = data.map(d => d.name || d[0] || 'Unknown');
                    const goals = data.map(d => parseFloat(d.goalAmount || d[1] || 0));
                    const currents = data.map(d => parseFloat(d.currentAmount || d[2] || 0));

                    const ctx = document.getElementById('programProgressChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [
                                {
                                    label: 'Current Amount (₫)',
                                    data: currents,
                                    backgroundColor: '#6366f1',
                                    borderRadius: 4,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Remaining Goal (₫)',
                                    // Plot the remaining needed to reach the goal
                                    data: currents.map((cur, i) => Math.max(0, goals[i] - cur)),
                                    backgroundColor: '#e2e8f0',
                                    borderRadius: 4,
                                    stack: 'Stack 0'
                                }
                            ]
                        },
                        options: {
                            indexAxis: 'y', // Horizontal bar
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        usePointStyle: true,
                                        font: { size: 11, family: 'Inter' }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => {
                                            if (ctx.datasetIndex === 0) {
                                                return 'Current: ' + ctx.raw.toLocaleString('vi-VN') + ' ₫';
                                            } else {
                                                return 'Remaining: ' + ctx.raw.toLocaleString('vi-VN') + ' ₫';
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        font: { size: 10 }, color: '#64748b',
                                        callback: v => (v >= 1000000 ? (v / 1000000).toFixed(1) + 'M' : v.toLocaleString()) + ' ₫'
                                    }
                                },
                                y: {
                                    stacked: true,
                                    grid: { display: false },
                                    ticks: { font: { size: 11 }, color: '#64748b' }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error('Program Progress chart error:', e);
                }
            })();

            // ── Line Chart : User Growth ───────────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/chart/user-growth');
                    const data = await resp.json();

                    const labels = data.map(d => d.date || d[0] || '');
                    const counts = data.map(d => parseInt(d.userCount || d[1] || 0));

                    const ctx = document.getElementById('userGrowthChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'New Registrations',
                                data: counts,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16,185,129,.10)',
                                borderWidth: 2.5,
                                pointBackgroundColor: '#10b981',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.4,
                                fill: true,
                                stepped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.parsed.y + ' users'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: '#f1f5f9' },
                                    ticks: { font: { size: 11 }, color: '#64748b' }
                                },
                                y: {
                                    grid: { color: '#f1f5f9' },
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1, // Whole numbers for users
                                        font: { size: 11 }, color: '#64748b',
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error('User Growth chart error:', e);
                }
            })();

            // ── Sidebar toggle ────────────────────────────────────────────────
            document.getElementById('sidebarToggle')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });
        </script>
    </th:block>
</body>

</html>