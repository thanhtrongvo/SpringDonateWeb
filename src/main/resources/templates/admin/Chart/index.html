<!DOCTYPE html>
<html layout:decorate="~{admin/fragments/_layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Dashboard – SGU Heart Admin</title>
</head>

<body>
    <div layout:fragment="content">

        <!-- ── Page Header ── -->
        <div class="page-header">
            <div>
                <h1>Dashboard</h1>
                <div class="breadcrumb">
                    <span>Admin</span> / <span style="color:#6366f1;">Dashboard</span>
                </div>
            </div>
            <a th:href="@{/}" target="_blank" class="btn btn-light" style="gap:8px;">
                <i class="bi bi-eye me-1"></i>View Site
            </a>
        </div>

        <!-- ── Stat Cards ── -->
        <div class="row g-4 mb-4">

            <!-- Total Donations Amount -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-1">
                    <div class="stat-icon">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="stat-label">Total Raised</div>
                    <div class="stat-value"
                        th:text="${totalDonationsAmount != null ? #numbers.formatDecimal(totalDonationsAmount, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">
                        0 ₫
                    </div>
                    <div class="stat-sub">All-time donation amount</div>
                </div>
            </div>

            <!-- Total Donations Count -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-2">
                    <div class="stat-icon">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    <div class="stat-label">Total Donations</div>
                    <div class="stat-value" th:text="${totalDonationsCount}">0</div>
                    <div class="stat-sub">Successful transactions</div>
                </div>
            </div>

            <!-- Total Programs -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-3">
                    <div class="stat-icon">
                        <i class="bi bi-journal-richtext"></i>
                    </div>
                    <div class="stat-label">Active Programs</div>
                    <div class="stat-value" th:text="${totalPrograms}">0</div>
                    <div class="stat-sub">Fundraising campaigns</div>
                </div>
            </div>

            <!-- Registered Users -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card stat-card-4">
                    <div class="stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-label">Registered Users</div>
                    <div class="stat-value" th:text="${totalUsers}">0</div>
                    <div class="stat-sub">Community members</div>
                </div>
            </div>
        </div>

        <!-- ── Charts ── -->
        <div class="row g-4 mb-4">

            <!-- Line Chart – Donations over time -->
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-graph-up me-2 text-primary"></i>Donations Overview</h6>
                        <span class="badge" style="background:#e0e7ff; color:#6366f1; font-size:11px;">Last 30
                            days</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="donationsLineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Doughnut – by program -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="bi bi-pie-chart-fill me-2 text-info"></i>By Program</h6>
                    </div>
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <div class="chart-pie">
                            <canvas id="programPieChart"></canvas>
                        </div>
                        <div id="pieLegend" class="mt-3 w-100" style="font-size:12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── Quick Links ── -->
        <div class="row g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="bi bi-lightning-charge me-2 text-warning"></i>Quick Access</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/user}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#e0e7ff'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-people-fill fs-3 mb-2" style="color:#6366f1;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Users</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/programs}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#d1fae5'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-journal-richtext fs-3 mb-2" style="color:#10b981;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Programs</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/donations}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#cffafe'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-cash-coin fs-3 mb-2" style="color:#06b6d4;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Donations</span>
                                </a>
                            </div>
                            <div class="col-6 col-md-3">
                                <a th:href="@{/admin/blogs}"
                                    class="d-flex flex-column align-items-center justify-content-center p-4 text-decoration-none"
                                    style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; transition:.2s;"
                                    onmouseover="this.style.background='#fef3c7'"
                                    onmouseout="this.style.background='#f8fafc'">
                                    <i class="bi bi-file-text-fill fs-3 mb-2" style="color:#f59e0b;"></i>
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">Blogs</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ── Chart Scripts ── -->
    <th:block layout:fragment="scripts">
        <script>
            // ── Palette ──────────────────────────────────────────────────────
            const PALETTE = ['#6366f1', '#10b981', '#06b6d4', '#f59e0b', '#ef4444',
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16'];

            // ── Line Chart : Donations by Day ────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/donations/total-donations-by-day');
                    const data = await resp.json();
                    const labels = data.map(d => d.date || d[0] || '');
                    const amounts = data.map(d => d.totalAmount || d[1] || 0);

                    const ctx = document.getElementById('donationsLineChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Donations (₫)',
                                data: amounts,
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99,102,241,.10)',
                                borderWidth: 2.5,
                                pointBackgroundColor: '#6366f1',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.parsed.y.toLocaleString('vi-VN') + ' ₫'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: '#f1f5f9' },
                                    ticks: { font: { size: 11 }, color: '#64748b' }
                                },
                                y: {
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        font: { size: 11 }, color: '#64748b',
                                        callback: v => (v >= 1000000 ? (v / 1000000).toFixed(1) + 'M' : v.toLocaleString()) + ' ₫'
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error('Line chart error:', e);
                }
            })();

            // ── Doughnut Chart : By Program ───────────────────────────────────
            (async () => {
                try {
                    const resp = await fetch('/admin/donations/total-donations-by-program');
                    const data = await resp.json();
                    const labels = data.map(d => d.programName || d[0] || 'Unknown');
                    const amounts = data.map(d => d.totalAmount || d[1] || 0);
                    const colors = PALETTE.slice(0, labels.length);

                    const ctx = document.getElementById('programPieChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data: amounts,
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#fff',
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '68%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.label + ': ' + ctx.parsed.toLocaleString('vi-VN') + ' ₫'
                                    }
                                }
                            }
                        }
                    });

                    // Custom legend
                    const legend = document.getElementById('pieLegend');
                    labels.forEach((label, i) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px;';
                        item.innerHTML = `
                <div style="width:10px;height:10px;border-radius:3px;background:${colors[i]};flex-shrink:0;"></div>
                <span style="flex:1;color:#475569;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
                <span style="font-weight:600;color:#1e293b;">${amounts[i].toLocaleString('vi-VN')} ₫</span>
            `;
                        legend.appendChild(item);
                    });
                } catch (e) {
                    console.error('Pie chart error:', e);
                }
            })();

            // ── Sidebar toggle ────────────────────────────────────────────────
            document.getElementById('sidebarToggle')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });
        </script>
    </th:block>
</body>

</html>